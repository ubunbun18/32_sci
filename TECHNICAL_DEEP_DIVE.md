# WebGPU Monte Carlo π - 技術解説 (Extreme Optimization Deep Dive)

このプロジェクトでは、WebGPUを最大限に活用し、モンテカルロ法による円周率計算を極限まで高速化するために、いくつかの高度な技術的工夫を凝らしています。

---

## 🚀 1. 演算・アルゴリズムの工夫

### A. 高品質な乱数生成 (PCG Hash)
一般的な `LCR`（線形合同法）ではなく、統計的性質に優れた **PCG Hash** をWGSL上に実装しています。これにより、特定のシード値に依存しない質の高いランダム性と、GPUでの並列実行に適した計算効率を両立しています。
- [simulation.wgsl#L39-L43](./src/shaders/simulation.wgsl)

### B. IEEE 754 ビット操作による高速 Float 変換
通常、整数から `[0.0, 1.0)` の範囲の浮動小数点数を作るには浮動小数点除算（`/ 4294967296.0`）が必要ですが、本プロジェクトでは **IEEE 754 ビット表現を直接操作** しています。
- 手法：ランダムな `u32` の上位23ビット（`0x7FFFFF`）を抽出し、単精度浮動小数点の指数部を `0`（バイアス値127 = `0x3F800000u`）に設定することで、物理的に `[1.0, 2.0)` の範囲のビット列を生成。そこから `1.0` を引くことで `[0.0, 1.0)` を得ます。
- これにより、高コストな除算命令を完全に排除し、整数演算とビットキャスト、定数減算のみで極めて高速な変換を実現しています。
- [simulation.wgsl#L46-L55](./src/shaders/simulation.wgsl)

---

## ⚡ 2. GPU パフォーマンスの最適化

### A. Subgroups による集計の高速化 (Extreme Mode)
ブラウザとハードウェアがサポートしている場合、**Subgroups (SIMD-group)** 拡張機能を動的に有効化します。
- **課題**: 通常、数千ものスレッドが共有メモリや広域メモリの原子操作（`atomicAdd`）に同時にアクセスすると、激しいメモリアクセス競合（Contention）が発生し、GPUのストールを引き起こします。
- **解決策**: 本プロジェクトでは、Subgroup内でまず高速なレジスタ間通信（`subgroupAdd`）を行い、その代表スレッド（`subgroupElect`）のみが原子操作を行うよう、JS側でシェーダーを動的に書き換えます。これにより、**原子操作の頻度を 1/32 〜 1/64 に削減** し、スループットを劇的に向上させています。
- [gpu_manager.js#L126-L135](./src/core/gpu_manager.js)

### B. f16 (半精度) 圧縮と SoA 形式
可視化用の座標データ（X, Y）は、`f32` (32bit) ではなく **`f16` (16bit)** に圧縮してVRAMに格納しています。
- **VRAM帯域の節約**: データサイズを半分にすることで、メモリ転送のボトルネックを解消。
- **SoA (Structure of Arrays)**: `vec2` の配列ではなく、`out_x` と `out_y` を個別のバッファに分けることで、GPUのメモリアクセスを合体（Coalesce）させ、転送効率を最大化しています。

### C. バッチ処理によるカーネルオーバーヘッドの削減
1回のGPU起動（Dispatch）ごとに、各スレッドがループを回して複数のサンプルを計算します。これにより、GPUへのコマンド発行オーバーヘッドを分散させ、スループットを最大化しています。

---

## 🎨 3. デザインとユーザビリティ

### A. Minimalist / Glassmorphism UI
- **配色**: 宇宙的な深みを持つ「Deep Void Black」を基調とし、アクセントカラーにシアンとマゼンタを採用。
- **視認性**: リアルタイムで収束する様子を滑らかなグラフで表示し、計算の「進歩」を視覚的に体験できるように設計。

### B. 信頼性検証 (Verification Mode)
GPUの計算結果が「それっぽい値」に留まっていないか、CPU側のJavaScriptで全く同じロジックを実行し、1ビットの狂いもなく一致するかを検証する機能を備えています。

---

## 🛠️ 4. 開発・デプロイ環境

### A. Vite による開発環境
Vanilla JSながら、Viteを導入することで HMR（Hot Module Replacement）や WGSLアセットのインポート、`top-level-await` の利用を可能にしました。

### B. GitHub Actions による自動デプロイ
`main` ブランチにプッシュするだけで、自動的にビルドと GitHub Pages へのデプロイが走る CI/CD 環境を構築。最新の WebGPU 実装を常にウェブ上で試せるようになっています。
